var extend = require('../util').extend;
var P = require('../port');

module.exports = function (target) {
    return function link (path, port) {
        var segs =  path.split(/\./g);
        var lastSeg = segs.length - 1;
        var t = target;

        segs.forEach(function (seg, index) {
            var isLast = index == lastSeg;
            if (isLast) {
                t[seg] = bind(port, t[seg]);
            }
            else {
                t = t[seg] || (t[seg] = {})
            }
        });
    }
}

function bind (port, target) {
    if (!target) return port;
    if (!P.isPort(target)) return extend(port, target);
    port.listen ? P.linkTwoWay(target, port) : P.link(target, port);
    return target;
}
