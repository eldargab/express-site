var P = require('..');
var dd = require('./dependency-detection');

module.exports = function createComputable (fn, ctx) {
    var port, listener;

    var notify = function () {
        port.onchange();
    }

    port = P.listenable(
        function setter () {},
        function getter () {
            dd.register(port);

            if (listener) listener.dispose(); 

            listener = dd.start(notify);
            var val = fn.call(ctx || this);
            dd.end();

            return val;
        }
    );

    port.mix = function (fn) {
        fn(this);
        return this;
    }

    return port;
}
