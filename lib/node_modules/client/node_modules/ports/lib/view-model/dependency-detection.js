module.exports = new Detection;

function Detection () {
    var self = this;
    var stack = [];
    var top;
    
    this.register = function (port) {
        if (top)
            top.listen(port);
    }
    
    this.start = function (notify) {
        top = new Listener(notify);
        stack.push(top);
        return top;
    }

    this.end = function () {
        top = stack.pop();
    }
}

Detection.prototype.newInstance = function () {
    return new Detection;
}

function Listener (notify) {
    this.ports = [];
    this.notify = notify;
}

Listener.prototype.dispose = function () {
    var notify = this.notify;
    this.ports.forEach(function (p) {
        p.removeListener(notify);
    });
    this.ports = null;
}

Listener.prototype.listen = function (p) {
    this.ports.push(p);
    p.addListener(this.notify);
}
