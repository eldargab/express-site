var P = require('./port');

module.exports = function serialize (obj) {
    var type = typeof obj

    switch (type) {
        case 'string':
        case 'boolean':
        case 'number':
        case 'undefined':
            return obj;

        case 'function':
            if (P.isPort(obj)) return serialize(obj());
            return;
    }

    if (obj === null) return null;

    if (obj.toJSON) return obj.toJSON();

    if (Array.isArray(obj)) {
        var ta = [];
        obj.forEach(function (val, index) {
           ta[index] = serialize(val);
        })
        return ta;
    }

    var t = {}
    for (var key in obj) {
        var val = serialize(obj[key]);
        if (val !== undefined)
            t[key] = val;
    }
    return t;
}
